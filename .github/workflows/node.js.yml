name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    # 1. Definición del Servicio de Base de Datos (MySQL)
    services:
      mysql:
        # Usa una imagen de Docker para MySQL
        image: mysql:8.0
        env:
          # Variable de entorno que MySQL Docker necesita para la contraseña de root
          # DEBES USAR UN SECRETO DE GITHUB AQUÍ, NUNCA UNA CONTRASEÑA EN TEXTO PLANO.
          MYSQL_ROOT_PASSWORD: ${{ secrets.DB_PASSWORD_TEST }} 
          # Crea una base de datos de prueba automáticamente
          MYSQL_DATABASE: test_db
        ports:
          # Mapea el puerto estándar de MySQL
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    
    # 2. Variables de Entorno para la Aplicación Node.js
    env:
      # El host es 127.0.0.1 porque el runner se conecta al servicio a través de localhost
      DB_HOST: 127.0.0.1 
      DB_USER: root
      DB_PASSWORD: ${{ secrets.DB_PASSWORD_TEST }}
      DB_NAME: test_db
      PORT: 3000 # Asegúrate de que este es el puerto que usa tu Express
      
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install Dependencies
      run: npm ci

    # 3. Instalación del Cliente MySQL y Espera
    - name: Wait for MySQL and Install Client
      run: |
        sudo apt-get update && sudo apt-get install -y mysql-client
        sleep 10 # Espera simple para que el servicio inicie y esté saludable

    # 4. Configurar la Base de Datos (Creación de Tablas e Inserción de Datos Iniciales)
    - name: Setup Database Schema and Seed Data
      run: |
        # Concatena todas tus sentencias SQL en un solo comando para el cliente MySQL
        mysql -h ${DB_HOST} -u ${DB_USER} -p${DB_PASSWORD} ${DB_NAME} -e "
          CREATE TABLE categorias (id INT AUTO_INCREMENT PRIMARY KEY, nombre VARCHAR(100) NOT NULL, descripcion VARCHAR(255), fecha_alta DATETIME DEFAULT CURRENT_TIMESTAMP, fecha_act DATETIME DEFAULT CURRENT_TIMESTAMP);
          CREATE TABLE productos (id INT AUTO_INCREMENT PRIMARY KEY, nombre VARCHAR(100) NOT NULL, precio DECIMAL(10,2) NOT NULL, stock INT NOT NULL, categoria_id INT NOT NULL, fecha_alta DATETIME DEFAULT CURRENT_TIMESTAMP, fecha_act DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (categoria_id) REFERENCES categorias(id) ON DELETE CASCADE);
          INSERT INTO categorias (nombre, descripcion) VALUES ('Electrónica', 'Dispositivos electrónicos y gadgets'), ('Oficina', 'Material y accesorios de oficina');
          INSERT INTO productos (nombre, precio, stock, categoria_id) VALUES ('Laptop', 1500.50, 10, 1), ('Mouse', 25.99, 50, 1), ('Cuaderno', 5.00, 100, 2), ('Lapicero', 1.50, 200, 2);
        "

    - run: npm run build --if-present
    
    # 5. Ejecutar Pruebas
    - name: Run CRUD API Tests
      run: npm test 
      # ASUME: Tu script 'npm test' inicia el servidor Express, corre todas las pruebas HTTP
      # contra http://127.0.0.1:3000 y luego detiene el servidor.
